<form [formGroup]="form" (ngSubmit)="onSubmit()" class="flex flex-col gap-3">
  <div class="field">
    <label
      for="title"
      class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
      >Title</label
    >
    <input
      id="title"
      type="text"
      pInputText
      formControlName="title"
      placeholder="What needs to be done?"
      class="w-full"
    />
    <small
      class="block mt-1 text-xs text-red-500 font-medium"
      *ngIf="form.get('title')?.invalid && form.get('title')?.touched"
    >
      Title is required (max 100 chars).
    </small>
  </div>

  <div class="field">
    <label
      for="description"
      class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
      >Description</label
    >
    <textarea
      id="description"
      pInputTextarea
      formControlName="description"
      rows="4"
      class="w-full resize-none"
      placeholder="Add more details..."
    ></textarea>
  </div>

  <div class="grid grid-cols-2 gap-5">
    <div class="field">
      <label
        for="priority"
        class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
        >Priority</label
      >
      <p-dropdown
        id="priority"
        [options]="priorities"
        formControlName="priority"
        placeholder="Select Priority"
        appendTo="body"
        styleClass="w-full"
      ></p-dropdown>
    </div>
    <div class="field">
      <label
        for="status"
        class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
        >Status</label
      >
      <p-dropdown
        id="status"
        [options]="statuses"
        formControlName="status"
        placeholder="Select Status"
        appendTo="body"
        styleClass="w-full"
      ></p-dropdown>
    </div>
  </div>

  <div class="grid grid-cols-2 gap-5">
    <div class="field">
      <label
        for="dueDate"
        class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
        >Due Date</label
      >
      <p-calendar
        id="dueDate"
        formControlName="dueDate"
        [showIcon]="true"
        iconDisplay="input"
        appendTo="body"
        styleClass="w-full"
        inputStyleClass="w-full"
        placeholder="mm/dd/yyyy"
      ></p-calendar>
    </div>
    <div class="field">
      <label
        for="assignedUserId"
        class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-1.5"
        >Assignee</label
      >
      <p-dropdown
        id="assignedUserId"
        [options]="users"
        optionLabel="name"
        optionValue="id"
        formControlName="assignedUserId"
        placeholder="Assign to..."
        appendTo="body"
        styleClass="w-full"
      ></p-dropdown>
    </div>
  </div>

  <div class="field mt-2">
    <div class="flex justify-between items-center mb-1.5">
      <label
        class="block text-sm font-semibold text-slate-700 dark:text-slate-300"
        >Subtasks</label
      >
      <button
        pButton
        type="button"
        icon="pi pi-plus"
        label="Add"
        class="p-button-text p-button-sm"
        (click)="addSubtask()"
      ></button>
    </div>

    <div formArrayName="subtasks" class="flex flex-col gap-2">
      <div
        *ngFor="let subtask of subtasks.controls; let i = index"
        [formGroupName]="i"
        class="flex items-center gap-2"
      >
        <div class="flex-shrink-0">
          <p-checkbox
            formControlName="isCompleted"
            [binary]="true"
            (onChange)="recalculateStatus()"
            ariaLabel="Toggle subtask completion"
          ></p-checkbox>
        </div>
        <input
          type="text"
          pInputText
          formControlName="title"
          placeholder="Subtask title"
          class="flex-1 p-inputtext-sm"
          aria-label="Subtask title"
        />
        <button
          type="button"
          pButton
          icon="pi pi-trash"
          class="p-button-danger p-button-text p-button-sm flex-shrink-0 !p-0 !w-8 !h-8"
          (click)="removeSubtask(i)"
        ></button>
      </div>
    </div>

    <small
      *ngIf="subtasks.length > 10"
      class="block mt-2 text-xs text-orange-500 font-medium"
    >
      <i class="pi pi-exclamation-triangle mr-1"></i>
      Consider breaking this into smaller tasks (soft limit of 10 subtasks).
    </small>

    <div
      *ngIf="subtasks.length === 0"
      class="text-xs text-slate-400 dark:text-slate-500 italic py-2 text-center border border-dashed border-slate-200 dark:border-slate-800 rounded"
    >
      No subtasks added yet.
    </div>
  </div>

  <div
    class="flex justify-end gap-3 mt-2 pt-4 border-t border-slate-100 dark:border-slate-800"
  >
    <button
      pButton
      type="button"
      label="Cancel"
      class="p-button-text p-button-secondary"
      (click)="cancel.emit()"
    ></button>
    <button
      pButton
      type="submit"
      [label]="task ? 'Update Task' : 'Create Task'"
      [disabled]="form.invalid"
    ></button>
  </div>
</form>
